/*
 * MyWindow.cc
 *
 *  Created on: 7 íîÿá. 2019 ã.
 *      Author: nito
 */
#include "MyWindow.h"
#include <GL/gl.h>
#include <GL/glu.h>
#include <cmath>
#include <algorithm>
#include <vector>

static const double Pi = acos(-1);

using VertexVector = std::vector<std::vector<GLdouble>>;
using NormalVector = std::vector<std::vector<GLdouble>>;
using FaceVector = std::vector<std::vector<int>>;
using TexCoordVector = std::vector<std::vector<std::vector<GLdouble>>>;

struct Model {
	VertexVector vertices;
	FaceVector faces;
	NormalVector normals;
	TexCoordVector texcoords;
};

static const VertexVector madhouse_vertices {
	{ -1., 0., 2.5 }, //0
	{ 1., 0., 2.5 },  //1
	{ -1., -1., 2. }, //2
	{ -1., 1., 2. },  //3
	{ 1., 1., 2. },   //4
	{ 1., -1., 2. },  //5
	{ -1., -1., 0. }, //6
	{ -1., 1., 0. },  //7
	{ 1., 1., 0. },   //8
	{ 1., -1., 0. },  //9

	{-0.5, 1., 0.},	   //10
	{0.5, 1., 0.},     //11
	{-0.5, 1., 1.5},   //12
	{0.5, 1., 1.5},    //13
	{-0.5, 1., 2.},    //14
	{0.5, 1., 2},      //15

	{1., 0.5, 1.5},    //16
	{1., -0.5, 1.5},   //17
	{1., 0.5, 0.5},    //18
	{1., -0.5, 0.5},   //19
	{1., 0.5, 2},      //20
	{1., -0.5, 2},     //21
	{1., 0.5, 0},      //22
	{1., -0.5, 0},     //23

	{ -0.9, -0.9, 0. },  //24
	{ -0.9, 0.9, 0. },   //25
	{ 0.9, 0.9, 0. },    //26
	{ 0.9, -0.9, 0. },   //27

	{ -0.9, -0.9, 1.9 }, //28
	{ -0.9, 0.9, 1.9 },  //29
	{ 0.9, 0.9, 1.9 },   //30
	{ 0.9, -0.9, 1.9 },  //31

	{0.9, -0.5, 1.5},   //32
	{0.9, 0.5, 1.5},   //33
	{0.9, 0.5, 0.5},    //34
	{0.9, -0.5, 0.5},    //35

	{0.9, -0.5, 0.},    //36
	{0.9, 0.5, 0.},     //37
	{0.9, 0.5, 1.9},    //38
	{0.9, -0.5, 1.9},   //39

	{-0.5, 0.9, 0.},	   //40
	{0.5, 0.9, 0.},     //41
	{-0.5, 0.9, 1.5},   //42
	{0.5, 0.9, 1.5},    //43
	{-0.5, 0.9, 2.},    //44
	{0.5, 0.9, 2},      //45

//vnizy tochi divana

	{-0.5, -0.3, 0.1},//46
	{-0.5, -0.2, 0.1},//47
	{-0.5, 0.2, 0.1},//48
	{-0.35, -0.2, 0.1},//49

	{-0.35, 0.2, 0.1},//50
	{0.35, -0.2, 0.1},//51
	{0.35, 0.2, 0.1},//52
	{0.5, -0.3, 0.1},//53

	{0.5, -0.2, 0.1},//54
	{0.5, 0.2, 0.1},//55

	{-0.35, -0.2 ,0.3},//56
	{0.35, -0.2, 0.3},//57
	{-0.35, 0.2, 0.3},//58
	{0.35, 0.2, 0.3},//59

	{-0.5, -0.3, 0.7},//60
	{0.5, -0.3, 0.7},//61
	{-0.5, -0.2, 0.7},//62
	{0.5, -0.2, 0.7},//63

	{-0.5, -0.2, 0.5},//64
	{-0.35, -0.2, 0.5},//65
	{-0.35, 0.2, 0.5},//66
	{-0.5, 0.2, 0.5},//67

	{0.35, -0.2, 0.5},//68
	{0.5, -0.2, 0.5},//69
	{0.5, 0.2, 0.5 },//70
	{0.35, 0.2, 0.5},//71

	//cover
	{-0.85, -0.7, 1.8},//72
	{-0.85, 0.7, 1.8 },//73
	{-0.85, 0.7, 0.2},//74
	{-0.85, -0.7, 0.2},//75
};

static const FaceVector madhouse_faces {
    //{ 0, 2, 6, 7, 3 },//bok bez okna
	{0,2,3},
	{3,2,6,7},

	{1, 4, 5},
	{20, 4, 8, 22 },
	{21, 20, 16, 17},//bok s okno
	{5, 21, 23, 9},
	{19, 18, 22, 23},

	{14, 3, 7, 10},
	{15, 14, 12, 13},//dver dira
	{4, 15, 11, 8},

	{31,28,24,27},//zad vnytr
	{24,28,29,25},//bok bez okna vnytr

	{39,31,27,36},
	{30,38,37,26},
	{38,39,32,33},//vnutr s oknom
	{34,35,36,37},

	{44,29,25,40},
	{30,45,41,26},//vnutr dver
	{45,44,42,43},

	{ 2, 5, 9, 6 },//zad
	//{ 7, 6, 9, 8 },//pol
	{ 1, 0, 3, 4 },//krisha pered
	{ 0, 1, 5, 2 },//krisha zad

	//vnizy divan
	{49, 47, 48, 50},
	{51, 49, 50, 52},
	{54, 51, 52, 55},
	{53, 46, 47, 54},

	{57, 56, 58, 59},
	{61, 60, 62, 63},
	{64, 65, 66, 67},
	{68, 69, 70, 71},

	{59, 58, 50, 52},
	{61, 60, 46, 53},

	{62, 60, 46, 47},
	{63, 61, 53, 54},

	{64, 47, 48, 67},//
	{70, 55, 54, 69},//

	{63, 62, 47, 54},

	{66, 67, 48, 50},
	{70, 71, 52, 55},

	{71, 68, 51, 52},
	{65, 66, 50, 49},

	//cover
	{72, 73, 74, 75},
};

static const NormalVector madhouse_normals {
	{ -1., 0., 0. },
	{ -1., 0., 0. },

	{ 1., 0., 0. },
	{ 1., 0., 0. },
	{ 1., 0., 0. },
	{ 1., 0., 0. },
	{ 1., 0., 0. },

	{ 0., 1., 0. },
	{ 0., 1., 0. },
	{ 0., 1., 0. },

	{ 0., 1., 0. },
	{ 1., 0., 0. },

	{ -1., 0., 0. },
	{ -1., 0., 0. },
	{ -1., 0., 0. },
	{ -1., 0., 0. },

	{ 0., -1., 0. },
	{ 0., -1., 0. },
	{ 0., -1., 0. },

	{ 0., -1., 0. },
	//{ 0., 0., -1. },
	{ 0., 0.4472, 0.8944},
	{ 0., -0.4472, 0.8944},

	//vnizy divan
	{0., 0., 1},
	{0., 0., 1},
	{0., 0., 1},
	{0., 0., 1},

	{0., 0., 1},
	{0., 0., 1},
	{0., 0., 1},
	{0., 0., 1},

	{0., 1., 0},
	{0., -1., 0},

	{-1., 0., 0.},
	{1., 0., 0.},

	{-1., 0., 0.},//
	{1., 0., 0.},//

	{0., 1., 0.},

	{0., 1., 0.},
	{0., 1., 0.},

	{-1., 0., 0.},
	{1., 0., 0.},

	//cover

	{1., 0., 0.},
};

static const TexCoordVector madhouse_tc {
	{ {0.1665, 0.1}, {0., 0.}, {0.333, 0.} },
	{ {0., 0.}, {0.333, 0.}, {0.333, 0.5}, {0., 0.5} },

	{ {0.1665, 0.1}, {0., 0.}, {0.333, 0.} },
	{ {0., 0.}, {0.1665, 0.}, {0.1665, 0.5}, {0., 0.5} },
	{ {0., 0.}, {0.333, 0.}, {0.333, 0.1}, {0., 0.1} },
	{ {0., 0.}, {0.1665, 0.}, {0.1665, 0.5}, {0., 0.5} },
	{ {0., 0.}, {0.333, 0.}, {0.333, 0.1}, {0., 0.1} },

	{ {0., 0.}, {0.1665, 0.}, {0.1665, 0.5}, {0., 0.5} },
	{ {0., 0.}, {0.333, 0.}, {0.333, 0.1}, {0., 0.1} },
	{ {0., 0.}, {0.1665, 0.}, {0.1665, 0.5}, {0., 0.5} },

	{ {0.333, 0.7}, {0.667, 0.7}, {0.667, 1.}, {0.333, 1.} },
	{ {0.333, 0.7}, {0.667, 0.7}, {0.667, 1.}, {0.333, 1.} },

	{ {0.333, 0.7}, {0.667, 0.7}, {0.667, 1.}, {0.333, 1.} },
	{ {0.333, 0.7}, {0.667, 0.7}, {0.667, 1.}, {0.333, 1.} },
	{ {0.333, 0.7}, {0.667, 0.7}, {0.667, 1.}, {0.333, 1.} },
	{ {0.333, 0.7}, {0.667, 0.7}, {0.667, 1.}, {0.333, 1.} },

	{ {0.333, 0.7}, {0.667, 0.7}, {0.667, 1.}, {0.333, 1.} },
	{ {0.333, 0.7}, {0.667, 0.7}, {0.667, 1.}, {0.333, 1.} },
	{ {0.333, 0.7}, {0.667, 0.7}, {0.667, 1.}, {0.333, 1.} },

	{ {0., 0.}, {0.333, 0.}, {0.333, 0.5}, {0., 0.5} },
	//{ {0.333, 0.}, {0.667, 0.}, {0.667, 0.2}, {0.333, 0.2} },
	{ {0.667, 0.}, {1., 0.}, {1., 0.5}, {0.667, 0.5}},
	{ {0.667, 0.5}, {1., 0.5}, {1., 1.}, {0.667, 1.}},

	//vnizy divan
	{ {0., 0.5}, {0.333, 0.5}, {0.333, 1.}, {0., 1.} },
	{ {0., 0.5}, {0.333, 0.5}, {0.333, 1.}, {0., 1.} },
	{ {0., 0.5}, {0.333, 0.5}, {0.333, 1.}, {0., 1.} },
	{ {0., 0.5}, {0.333, 0.5}, {0.333, 1.}, {0., 1.} },

	{ {0., 0.5}, {0.333, 0.5}, {0.333, 1.}, {0., 1.} },
	{ {0., 0.5}, {0.333, 0.5}, {0.333, 1.}, {0., 1.} },
	{ {0., 0.5}, {0.333, 0.5}, {0.333, 1.}, {0., 1.} },
	{ {0., 0.5}, {0.333, 0.5}, {0.333, 1.}, {0., 1.} },

	{ {0., 0.5}, {0.333, 0.5}, {0.333, 1.}, {0., 1.} },
	{ {0., 0.5}, {0.333, 0.5}, {0.333, 1.}, {0., 1.} },

	{ {0., 0.5}, {0.333, 0.5}, {0.333, 1.}, {0., 1.} },
	{ {0., 0.5}, {0.333, 0.5}, {0.333, 1.}, {0., 1.} },

	{ {0., 0.5}, {0.333, 0.5}, {0.333, 1.}, {0., 1.} },//
	{ {0., 0.5}, {0.333, 0.5}, {0.333, 1.}, {0., 1.} },//

	{ {0., 0.5}, {0.333, 0.5}, {0.333, 1.}, {0., 1.} },

	{ {0., 0.5}, {0.333, 0.5}, {0.333, 1.}, {0., 1.} },
	{ {0., 0.5}, {0.333, 0.5}, {0.333, 1.}, {0., 1.} },

	{ {0., 0.5}, {0.333, 0.5}, {0.333, 1.}, {0., 1.} },
	{ {0., 0.5}, {0.333, 0.5}, {0.333, 1.}, {0., 1.} },

	//cover

	{ {0.333, 0.}, {0.666, 0.}, {0.666, 0.2}, {0.333, 0.2} },
};

static const Model madhouse_model {
	madhouse_vertices,
	madhouse_faces,
	madhouse_normals,
	madhouse_tc
};

void draw_model(const Model& m)
{
	for (size_t face = 0; face < m.faces.size(); face++) {
		size_t nv = m.faces[face].size();
		if (nv == 3) glBegin(GL_TRIANGLES);
		else if (nv == 4) glBegin(GL_QUADS);
		else glBegin(GL_TRIANGLE_FAN);
		glNormal3dv(&m.normals[face][0]);
		for (size_t v = 0; v < nv; v++) {
			size_t vi = m.faces[face][v];
			glTexCoord2dv(&m.texcoords[face][v][0]);
			glVertex3dv(&m.vertices[vi][0]);
		}

		glEnd();
	}
}

void MyWindow::setup_gl()
{
//	glClearColor(0.2f, 0.1f, 0.8f, 1.0f);
	glClearColor(0.4f, 0.6f, 1.0f, 1.0f);
	glEnable(GL_DEPTH_TEST);
	glEnable(GL_LIGHTING);
	glEnable(GL_LIGHT0);
	glEnable(GL_TEXTURE);
	glMatrixMode(GL_PROJECTION);
	gluPerspective(45.0, 800./600., 0.1, 120.0);
	glMatrixMode(GL_MODELVIEW);
}

void MyWindow::render()
{
	glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);

	glLoadIdentity();
	gluLookAt(0.2, 0.8, 0.68, 0, 0, 0.81, 0, 0, 1);

	static double a = 0;
	a += 0.15;

	glRotated(a, 0., 0., 1.0);

	glEnable(GL_TEXTURE_2D);
	_madhouse_texture.bind();

	glBegin(GL_QUADS);
	glNormal3d(0., 0., 1.);
	glTexCoord2d(0.333, 0.5); glVertex3d(-30., -30., 0.);
	glTexCoord2d(0.667, 0.5);glVertex3d(30., -30., 0.);
	glTexCoord2d(0.667, 0.7); glVertex3d(30., 30., 0.);
	glTexCoord2d(0.333, 0.7); glVertex3d(-30., 30., 0.);
	glEnd();

	draw_model(madhouse_model);
//	for (int i = -4; i <= -4; i++)
//		for (int j = -4; j <= 4; j++) {
//			glPushMatrix();
//
//			glTranslated(5.3 * i, 5.3 * j, 0.);
//
//			draw_model(madhouse_model);
//			glPopMatrix();
//		}

}



